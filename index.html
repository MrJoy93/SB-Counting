<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SB-Counting</title>
<style>
  :root{
    --brand:#00f5ff; --panel:rgba(30,38,60,.78); --text:#eaf6ff; --muted:#97e4f5;
    --checked-bg: rgba(0,245,255,.14); --checked-border: rgba(0,245,255,.55);
  }
  *{box-sizing:border-box}
  body{margin:0;background:#121826;color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"M PLUS 2",sans-serif}
  header{position:sticky;top:0;background:#1a2134;border-bottom:1px solid rgba(0,245,255,.25);padding:10px 16px;z-index:50}
  header h1{margin:0;font-size:16px}
  .tabs-bar{display:flex;align-items:center;gap:12px}
  header .tabs{flex:1}
  nav.tabs{display:flex;gap:8px;align-items:center;margin-top:8px;overflow-x:auto}
  .tab-btn{appearance:none;border:1px solid rgba(0,245,255,.35);background:#141a2a;color:#b9e9f5;padding:8px 14px;border-radius:10px;cursor:pointer}
  .tab-btn[aria-selected="true"]{color:#00f5ff;border-color:#00f5ff}
  .overall-unpaid{margin-left:auto;font-weight:700;color:#eaf6ff;background:rgba(0,245,255,.16);border:1px solid rgba(0,245,255,.35);padding:6px 10px;border-radius:10px;white-space:nowrap}

  main{max-width:none;margin:16px auto 48px;padding:0 12px}
  .panel{display:none;background:var(--panel);border:1px solid rgba(0,245,255,.18);border-radius:12px;padding:14px}
  .panel.active{display:block}
  .heading{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:0 0 8px}
  .main-unpaid{font-weight:700;color:#eaf6ff;background:rgba(0,245,255,.12);border:1px solid rgba(0,245,255,.35);padding:6px 10px;border-radius:10px;white-space:nowrap}

  .name-form{margin:6px 0 10px;padding:10px;border:1px solid rgba(0,245,255,.22);border-radius:10px;background:rgba(16,24,40,.55)}
  .label{font-size:12px;color:var(--muted);letter-spacing:.12em;display:inline-block;margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input, input{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,245,255,.35);background:#273a57;color:#eaf6ff}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,245,255,.35);background:#1c2a4a;color:#eaf6ff;cursor:pointer}

  .table-wrap{width:100%;overflow-x:auto}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#162038;border-radius:12px;table-layout:fixed;font-size:14px}
  th,td{white-space:nowrap;border-bottom:1px solid rgba(0,245,255,.25);padding:6px}
  th{background:#20365a;color:#00f5ff}
  tr:last-child td{border-bottom:none}

  /* widths */
  table th:first-child, table td:first-child{width:44px}
  table th:nth-child(2), table td:nth-child(2){min-width:110px;max-width:160px;overflow:hidden;text-overflow:ellipsis}
  table th:last-child, table td:last-child{width:96px}
  .amount-cell,.unpaid-cell,.remain-cell{min-width:100px;text-align:right;font-weight:bold}

  .date-td{transition:background .18s ease, box-shadow .18s ease}
  .date-td.is-checked{background:var(--checked-bg);box-shadow:inset 0 0 0 1px var(--checked-border)}
  .date-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;padding:2px 0}
  .day-check{width:18px;height:18px;accent-color:var(--brand)}
  .md-input{width:72px;text-align:center}
  .md-input.invalid{border-color:#f43f5e;box-shadow:0 0 8px rgba(244,63,94,.35)}

  .buy-cell{text-align:right}
  .completed-wrap{margin-top:14px}
  .completed-wrap h4{margin:8px 0 6px;font-size:14px;color:#9fb9c9}

  /* modal for SB buy editing (tab1-3 only) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .dialog{position:relative;background:#0f172a;border:1px solid rgba(0,245,255,.25);border-radius:12px;min-width:320px;max-width:640px;width:90%;padding:14px}
  .modal h4{margin:0 0 8px;font-size:16px}
  .buy-list{display:grid;grid-template-columns:1fr 140px;gap:8px;max-height:50vh;overflow:auto;margin:8px 0}
  .buy-list .name{align-self:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .buy-list input{width:100%}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

  /* Adviser (在籍顧問) のグループ見出し＆小計行 */
.group-row td{
  background:#20365a;
  color:#bfefff;
  font-weight:700;
  border-bottom:1px solid rgba(0,245,255,.35);
}
.group-subtotal td{
  background:#1a2b49;
  color:#eaf6ff;
  font-weight:700;
  border-top:1px dashed rgba(0,245,255,.35);
}

/* スマホ画面の調整 */
@media (max-width: 600px) {
  header h1 { font-size: 14px; }
  .tab-btn { padding:6px 10px; font-size:12px; }
  .input, input, .btn { font-size:14px; padding:6px 8px; }

  /* フォーム行は縦積み */
  .row {
    flex-direction: column;
    align-items: stretch;
  }
  .row .input, .row .btn {
    width: 100%;
  }

  /* テーブルは横スクロールを前提に */
  table { font-size: 12px; }
  th, td { padding:4px; }
}

nav.tabs {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.modal .dialog {
  max-height: 90vh;
  overflow-y: auto;
}

/* === Mobile Card Layout === */
@media (max-width: 720px) {
  /* テーブル→カード化の基本 */
  .table-wrap { overflow: visible; }
  table { display:block; border-collapse: initial; border-spacing:0; }
  thead { display:none; }
  tbody { display:block; }
  tbody tr {
    display:block;
    background:#162038;
    border:1px solid rgba(0,245,255,.18);
    border-radius:12px;
    margin:12px 0;
    padding:8px 10px;
    overflow:hidden;
  }
  tbody td {
    display:grid;
    grid-template-columns: 8.5em 1fr; /* 左がラベル、右が値 */
    gap:8px;
    align-items:center;
    border:none !important;
    padding:6px 4px;
    white-space:normal;
  }
  tbody td::before {
    content: attr(data-label);
    color: var(--muted);
    font-size: 12px;
    letter-spacing: .06em;
  }

  /* 金額系は強調しつつ右寄せ維持 */
  .amount-cell, .unpaid-cell, .remain-cell { text-align:right; font-weight:700; }

  /* 日付セル（D1〜D10）は詰めて表示 */
  .date-td .date-wrap { align-items:flex-start; gap:4px; }
  .day-check { width:20px; height:20px; }
  .md-input { width:90px; } /* タップしやすく */

  /* ボタンのタップ領域 */
  .btn { width:100%; min-height:40px; }

  /* 追加フォームは縦積みフル幅 */
  .row { flex-direction: column; align-items: stretch; }
  .row .input, .row .btn { width:100%; }

  /* モーダルは高さ優先でスクロール */
  .modal .dialog { max-height:90vh; overflow:auto; }
  .buy-list { max-height: 56vh; }
  
  /* 在籍顧問のグループ見出し/小計 行もカード風 */
  tr.group-row td, tr.group-subtotal td {
    display:block;
    grid-template-columns: 1fr !important;
    padding:10px !important;
  }
}

/* ===== Mobile header layout fix ===== */
@media (max-width: 720px) {
  /* ヘッダー全体を折り返し可に */
  .tabs-bar {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* 1行目：タブを横スクロールで全幅に */
  header .tabs {
    order: 1;
    flex: 1 1 100%;
    max-width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 6px; /* スクロールバーの余白 */
  }
  header .tabs .tab-btn {
    flex: 0 0 auto;      /* 折り返さず流せるように */
    white-space: nowrap;
  }

  /* 2行目：未払バッジは右寄せで縦に積む */
  #overall-unpaid,
  #adviser-unpaid {
    order: 2;            /* 同じ行に配置できるよう同順位 */
    margin-left: auto;   /* 右端へ寄せる */
    display: block;
    width: max-content;  /* コンテンツ幅に縮める */
  }
  #adviser-unpaid {      /* 下の段へ少し間隔 */
    margin-top: 6px;
  }

  /* 見切れ対策：ヘッダー内のテキスト微縮小 */
  header h1 { font-size: 14px; }
  .tab-btn { padding: 6px 10px; font-size: 12px; }
}

@media (max-width: 720px) {
  /* 日付セル内の配置を横並びに */
  .date-td .date-wrap {
    flex-direction: row;     /* ← 縦並び→横並び */
    justify-content: flex-start;
    align-items: center;
    gap: 6px;                /* チェックと日付の間隔 */
    padding: 0;
  }

  .day-check { width: 18px; height: 18px; }
  .md-input  { width: 72px; font-size: 12px; padding: 4px 6px; }
}

@media (max-width: 720px) {
  /* 操作セルは横並びでボタンだけ見せる */
  td[data-label="操作"] {
    display: flex !important;
    justify-content: flex-end;   /* 右寄せ */
    align-items: center;
    gap: 6px;
  }
  td[data-label="操作"]::before {
    content: "";   /* ラベルを消す */
  }
  td[data-label="操作"] .btn {
    width: auto;   /* 横幅いっぱいじゃなく適度なサイズ */
    min-height: 32px;
    padding: 4px 10px;
  }
}

@media (max-width: 720px) {
  .filter-row { display:block; }
}
@media (min-width: 721px) {
  .filter-row { display:none; } /* PCでは非表示 */
}


</style>
</head>
<body>
<header>
  <h1>SB-Counting Ver.2.3</h1>
  <div class="tabs-bar">
    <nav class="tabs" aria-label="Main Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab1">タチバナ</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab2">ＯＺ</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab3">その他</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab4">在籍顧問</button>
    </nav>
    <div class="overall-unpaid" id="overall-unpaid" aria-live="polite">総未払合計: ¥0</div>
    <div class="overall-unpaid" id="adviser-unpaid" aria-live="polite">顧問未払合計: ¥0</div>
  </div>
</header>

<main>
  <!-- ===== タチバナ ===== -->
  <section id="tab1" class="panel active">
    <div class="heading">
      <h2>タチバナ</h2>
      <div class="main-unpaid" data-main="tab1" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="タチバナ Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab1-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab1-sub2">SB</button>
    </nav>

    <!-- 足代 -->
    <section id="tab1-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab1-sub1">
        <label class="label" for="tab1-sub1-name">氏名</label>
        <div class="row">
          <input id="tab1-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>

      <div class="row filter-row" style="margin:6px 0;">
      <select class="input filter-select" data-panel="tab1-sub1">
      <option value="">すべて表示</option>
      </select>

</div>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab1-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SB -->
    <section id="tab1-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab1-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab1-sub2">
        <label class="label" for="tab1-sub2-name">氏名</label>
        <div class="row">
          <input id="tab1-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <input id="tab1-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>

      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab1-sub2">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab1-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== ＯＺ ===== -->
  <section id="tab2" class="panel">
    <div class="heading">
      <h2>ＯＺ</h2>
      <div class="main-unpaid" data-main="tab2" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="ＯＺ Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab2-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab2-sub2">SB</button>
    </nav>

    <section id="tab2-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab2-sub1">
        <label class="label" for="tab2-sub1-name">氏名</label>
        <div class="row">
          <input id="tab2-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>

      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab2-sub1">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab2-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab2-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab2-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab2-sub2">
        <label class="label" for="tab2-sub2-name">氏名</label>
        <div class="row">
          <input id="tab2-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <input id="tab2-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      
      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab2-sub2">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab2-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== その他 ===== -->
  <section id="tab3" class="panel">
    <div class="heading">
      <h2>その他</h2>
      <div class="main-unpaid" data-main="tab3" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="その他 Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab3-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab3-sub2">SB</button>
    </nav>

    <section id="tab3-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab3-sub1">
        <label class="label" for="tab3-sub1-name">氏名</label>
        <div class="row">
          <input id="tab3-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      
      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab3-sub1">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab3-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab3-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab3-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab3-sub2">
        <label class="label" for="tab3-sub2-name">氏名</label>
        <div class="row">
          <input id="tab3-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input type="text" class="input" name="staff" placeholder="担当">
          <input id="tab3-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      
      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab3-sub2">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab3-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== 在籍顧問 ===== -->
  <section id="tab4" class="panel">
    <div class="heading">
      <h2>在籍顧問</h2>
      <div class="main-unpaid" data-main="tab4" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="在籍顧問 Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab4-sub1">足代</button>
    </nav>

<form class="name-form" data-panel="tab4-sub1">
  <label class="label" for="tab4-sub1-name">氏名</label>
  <div class="row">
    <input id="tab4-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
    <input type="text" class="input" name="staff" placeholder="担当">
    <select class="input" name="group" aria-label="グループ選択">
      <option value="tab1">タチバナ</option>
      <option value="tab2">ＯＺ</option>
      <option value="tab3">その他</option>
    </select>
    <button class="btn" type="submit">追加</button>
  </div>
</form>

      <div class="row filter-row" style="margin:6px 0;">
  <select class="input filter-select" data-panel="tab4-sub1">
    <option value="">すべて表示</option>
  </select>
</div>

      <div class="table-wrap">
        <table class="name-table" data-panel="tab4-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>担当</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>
</main>

<!-- modal: SB buy editor -->
<div class="modal" id="buy-editor-modal" aria-hidden="true" role="dialog">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="document">
    <h4 data-title>買取金額を編集</h4>
    <div class="buy-list" aria-label="買取金額の一覧"></div>
    <div class="actions">
      <button class="btn" data-close type="button">キャンセル</button>
      <button class="btn" data-save type="button">保存</button>
    </div>
  </div>
</div>

<!-- Firebase compat SDK（v10系） -->
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>

<script>

// ★ あなたのプロジェクトの構成値で置き換えてください
const firebaseConfig = {
  apiKey: "AIzaSyCPO_USyv_nyATTSzB88ChJD7Jg0OuHdrg",
  authDomain: "sb-counting.firebaseapp.com",
  projectId: "sb-counting",
  storageBucket: "sb-counting.firebasestorage.app",
  messagingSenderId: "336851836369",
  appId: "1:336851836369:web:cac53c9aa8711831ead4f0",
  measurementId: "G-N8NBNC720Y"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();

// 匿名ログイン
auth.signInAnonymously().catch(console.error);

// テナントIDを固定（今回は "prod"）
const TENANT_ID = "prod";



  function focusCell(panelId, r, k){
  const sel = 'input.md-input[data-panel="'+panelId+'"][data-row="'+r+'"][data-di="'+k+'"]';
  const el = document.querySelector(sel);
  if(el){ el.focus(); if(el.select) el.select(); }
  }

  // Enterで次要素に移動（最後ならsubmit）
  function enableEnterTabbing(root){
  const sel = 'input, select, textarea, button';
  root.addEventListener('keydown', (e)=>{
    if(e.key !== 'Enter') return;
    if(e.target && e.target.tagName === 'TEXTAREA') return; // textareaは改行を優先
    e.preventDefault();
    const focusables = Array.from(root.querySelectorAll(sel))
      .filter(el => !el.disabled && el.type !== 'hidden' && el.offsetParent !== null);
    const i = focusables.indexOf(e.target);
    if(i > -1 && i < focusables.length - 1){
      focusables[i+1].focus();
    }else{
      const submit = root.querySelector('button[type="submit"], input[type="submit"]');
      if(submit) submit.click();
    }
  });
}

(function(){
  window.MAIN_TABS = ["tab1","tab2","tab3","tab4"];
  window.fmtJPY = new Intl.NumberFormat('ja-JP');
  const MD_RE = /^(0?[1-9]|1[0-2])\/(0?[1-9]|[12][0-9]|3[01])$/;
  const DD_RE = /^(0[1-9]|[12][0-9]|3[01])$/; // 在籍顧問用：日だけ
  // 3～4桁の「スラなし」(927, 0927, 1127, 0105 など)
  const MD_NUM_RE = /^\d{3,4}$/;

  // --- Firestore ドキュメント参照ショートカット ---
  window.panelDoc = function(panelId){
    return db.collection('tenants').doc(TENANT_ID)
             .collection('panels').doc(panelId);
  }

  // --- Firestore版 read/save ---
  window.readNames = async function(panelId){
    try {
      const snap = await panelDoc(panelId).get();
      return snap.exists ? (snap.data().names || []) : [];
    } catch(e){
      console.error("readNames error:", e);
      return [];
    }
  }
  window.saveNames = function(panelId, arr){
    panelDoc(panelId).set({ names: arr }, { merge: true })
      .catch(e=>console.error("saveNames error:", e));
  }

  window.readCompleted = async function(panelId){
    try {
      const snap = await panelDoc(panelId).get();
      return snap.exists ? (snap.data().completed || []) : [];
    } catch(e){
      console.error("readCompleted error:", e);
      return [];
    }
  }
  window.saveCompleted = function(panelId, arr){
    panelDoc(panelId).set({ completed: arr }, { merge: true })
      .catch(e=>console.error("saveCompleted error:", e));
  }

  // --- 既存の補助関数たちはそのまま ---
  window.esc = function(s){ return String(s).replace(/[&<>"']/g,
    c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])
  ); }

function parseMD(txt){
  const t = String(txt||"").trim();

  // ① スラなし 3～4桁（927, 0927 など）
  if(MD_NUM_RE.test(t)){
    const digits = t; // 3 or 4 digits
    let mm, dd;
    if(digits.length === 3){
      // 例: 927 -> 9 / 27
      mm = digits.slice(0,1);
      dd = digits.slice(1);
    }else{
      // 例: 0927, 1127 -> 09 / 27, 11 / 27
      mm = digits.slice(0,2);
      dd = digits.slice(2);
    }
    const m = Number(mm), d = Number(dd);
    if(m>=1 && m<=12 && d>=1 && d<=31){
      return { mm: String(m).padStart(2,'0'), dd: String(d).padStart(2,'0') };
    }
    return null;
  }

  // ② スラあり（9/7, 09/07 など）→ 02桁化して返す
  const m = t.match(MD_RE);
  if(m){
    const mm = String(Number(m[1])).padStart(2,'0');
    const dd = String(Number(m[2])).padStart(2,'0');
    return { mm, dd };
  }

  return null;
}

  window.isoToMD = function(iso){
    if(!iso) return "";
    const m=String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    return m? (m[2]+"/"+m[3]) : "";
  }

  function mdToISO(md, year){
    return md? (year+"-"+md.mm+"-"+md.dd) : "";
  }

  function inferYear(){ return new Date().getFullYear(); }

  window.normalizeData = function(raw){
    const toObj = (v)=>{
      if(!v) return { md:"", ymd:"", checked:false };
      if(typeof v === "string"){
        // "MM/DD"
        const md = parseMD(v);
        if(md) return { md: md.mm+"/"+md.dd, ymd:"", checked:false };
        // "YYYY-MM-DD"
        const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(m) return { md: m[2]+"/"+m[3], ymd: v, checked:false };
        return { md: String(v), ymd:"", checked:false };
      }
      return {
        md: v.md ? String(v.md) : "",
        ymd: v.ymd ? String(v.ymd) : "",
        checked: !!v.checked
      };
    };

    return (raw||[]).map(item=>{
      const name  = item?.name || (typeof item==='string' ? item : "");
      const buy   = Number(item?.buy||0);
      const group = item?.group ? String(item.group) : "";
      const staff = item?.staff ? String(item.staff) : "";
      let dates = item?.dates || [];
      if(!Array.isArray(dates)) dates = [];
      dates = dates.slice(0,10).map(toObj);
      while(dates.length < 10) dates.push({ md:"", ymd:"", checked:false });
      return { name, staff, buy, group, dates };
    });
  }

  // 値確定：在籍顧問はDDのみ保存（ymdは空）、その他はMM/DD→YYYY-MM-DDへ
document.addEventListener('change', async (e)=>{
  const el = e.target.closest('input.md-input'); if(!el) return;
  const panelId = el.dataset.panel; const r=Number(el.dataset.row), k=Number(el.dataset.di);
  const data = normalizeData(await readNames(panelId)); if(!data[r]) return;
  const raw = (el.value||"").trim();
  const isAdv = isAdviser(panelId);

  // ★ 次にフォーカスするターゲット（自然なTab順：同じ行の次→行送り）
  const totalSlots = (data[r].dates && data[r].dates.length) ? data[r].dates.length : 10;
  const nextK = (k + 1 < totalSlots) ? (k + 1) : 0;
  const nextR = (k + 1 < totalSlots) ? r : (r + 1);

  // 空入力（削除）の処理
  if(raw === ""){
    el.classList.remove('invalid');
    const wasChecked = !!(data[r].dates[k] && data[r].dates[k].checked);
    data[r].dates[k] = { md:"", ymd:"", checked: wasChecked };
    saveNames(panelId, data);
    renderTable(panelId);
    // ★ 再描画後に次セルへ
    setTimeout(()=>{ focusCell(panelId, nextR, nextK); }, 0);
    return;
  }

  if(isAdv){
    // 在籍顧問：DDのみ
    if(!DD_RE.test(raw)){ el.classList.add('invalid'); return; }
    el.classList.remove('invalid');
    const wasChecked = !!(data[r].dates[k] && data[r].dates[k].checked);
    data[r].dates[k] = { md: raw, ymd: "", checked: wasChecked };
    saveNames(panelId, data);
    renderTable(panelId);
    setTimeout(()=>{ focusCell(panelId, nextR, nextK); }, 0);
  }else{
    // 通常：MM/DD → YYYY-MM-DD
    const md = parseMD(raw);
    if(!md){ el.classList.add('invalid'); return; }
    el.classList.remove('invalid');
    const yyyy = inferYear();
    const wasChecked = !!(data[r].dates[k] && data[r].dates[k].checked);
    data[r].dates[k] = { md:(md.mm+"/"+md.dd), ymd: mdToISO(md, yyyy), checked: wasChecked };
    saveNames(panelId, data);
    renderTable(panelId);
    setTimeout(()=>{ focusCell(panelId, nextR, nextK); }, 0);
  }
});

})(); // IIFE終わり

  function isAdviser(panelId){ return String(panelId||'').indexOf('tab4')===0; }

  // 合計金額
  function calcAmount(panelId, dates){
    const filled = (dates||[]).filter(d=> d && d.md).length;
    if(isAdviser(panelId)){
      // 在籍顧問：10日到達で一律 20,000
      return filled>=10 ? 20000 : 0;
    }
    return panelId.endsWith('sub1') ? filled*5000 : panelId.endsWith('sub2') ? filled*20000 : 0;
  }

  // 未払金額
  function calcUnpaid(panelId, dates, total){
    if(isAdviser(panelId)){
      // 在籍顧問：控除なし → 未払＝発生額
      return Math.max(0, Number(total)||0);
    }
    const checkedCount = (dates||[]).filter(d=> !!d.checked).length;
    let unpaid = 0;
    if(panelId.endsWith('sub1')) unpaid = total - checkedCount*5000;
    if(panelId.endsWith('sub2')) unpaid = total - checkedCount*20000;
    return Math.max(0, unpaid);
  }

  function calcRemain(buy, total){ return Math.max(0, (Number(buy)||0) - total); }

  // タブ別未払合計
  function sumUnpaidForData(panelId, data){
    const isSB = panelId.endsWith('sub2');
    const isAdv = isAdviser(panelId);
    return (data||[]).reduce((acc,row)=>{
      const total  = calcAmount(panelId, row.dates||[]);
      const unpaid = calcUnpaid(panelId, row.dates||[], total);
      if(!isAdv && isSB){
        // 通常SB：買取金額−合計＝0 の行のみ未払合計に入れる
        const rawRemain = (Number(row.buy)||0) - total;
        if(rawRemain !== 0) return acc;
      }
      return acc + unpaid;
    }, 0);
  }

async function updateMainUnpaid(mainId){
  const badge = document.querySelector('.main-unpaid[data-main="'+mainId+'"]');
  if(!badge) return;
  const d1 = normalizeData(await readNames(mainId+'-sub1'));
  const d2 = normalizeData(await readNames(mainId+'-sub2'));
  const sum = sumUnpaidForData(mainId+'-sub1', d1) + sumUnpaidForData(mainId+'-sub2', d2);
  badge.textContent = '未払合計: ¥'+fmtJPY.format(sum);
  await updateOverallUnpaid();
}

async function updateOverallUnpaid(){
  const grandEl = document.getElementById('overall-unpaid');
  const advEl   = document.getElementById('adviser-unpaid');
  if(!grandEl) return;

  let grand = 0;
  let adviserSum = 0;

  for(const mid of MAIN_TABS){
    const d1 = normalizeData(await readNames(mid+'-sub1'));
    const d2 = normalizeData(await readNames(mid+'-sub2'));

    if(mid === 'tab4'){
      adviserSum += sumUnpaidForData(mid+'-sub1', d1);
    } else {
      grand += sumUnpaidForData(mid+'-sub1', d1) + sumUnpaidForData(mid+'-sub2', d2);
    }
  }

  grandEl.textContent = '総未払合計: ¥' + fmtJPY.format(grand);
  if(advEl){
    advEl.textContent = '顧問未払合計: ¥' + fmtJPY.format(adviserSum);
  }
}

  // テーブル描画
async function renderTable(panelId){
  const table = document.querySelector('table.name-table[data-panel="'+panelId+'"]');
  const tbody = table && table.querySelector('tbody'); if(!tbody) return;
  const data = normalizeData(await readNames(panelId));
  const isSB = panelId.endsWith('sub2');
  const isAdv = isAdviser(panelId);

  function groupLabel(id){
    return id==='tab1' ? 'タチバナ'
         : id==='tab2' ? 'ＯＺ'
         : id==='tab3' ? 'その他'
         : '未設定';
  }

  // === 在籍顧問：グループごとにまとめ、氏名は降順、グループ小計（金額）を表示 ===
  if(isAdv){
    // #, 氏名, 担当, D1..D10, 合計, 未払, 操作 = 16
    const COLS = 16;

    // バケット化
    const buckets = { tab1:[], tab2:[], tab3:[], _other:[] };
    data.forEach(function(row){ 
      const key = (row.group==='tab1' || row.group==='tab2' || row.group==='tab3') ? row.group : '_other';
      buckets[key].push(row);
    });

    // 氏名降順（ja ロケール）
    Object.keys(buckets).forEach(function(k){
      buckets[k].sort(function(a,b){
      return String(b.name||'').localeCompare(String(a.name||''), 'ja') * -1;
      });
    });

    const order = ['tab1','tab2','tab3','_other'];
    const htmlParts = [];

    order.forEach(function(g){
      const rows = buckets[g]; if(!rows || rows.length===0) return;
      const label = g==='_other' ? '未設定' : groupLabel(g);

      // グループ見出し行
      htmlParts.push('<tr class="group-row"><td colspan="'+COLS+'">グループ：'+esc(label)+'</td></tr>');

      let groupTotal = 0;

      rows.forEach(function(row){
        // 元データ上のインデックス（削除ボタン用）
        const originalIndex = data.indexOf(row);

const dateCells = (row.dates||[]).map(function(cell,k){
  // 在籍顧問は「DD」表示
  let v = '';
  if(cell){
    if(cell.md){
      const m = String(cell.md).match(/^\d{2}\/(\d{2})$/);
      v = m ? m[1] : String(cell.md).slice(-2);
    }else if(cell.ymd){
      v = String(cell.ymd).slice(-2);
    }
  }
  return '<td class="date-td" data-label="D'+(k+1)+'">\
    <div class="date-wrap">\
      <input type="text" inputmode="numeric" placeholder="DD" class="md-input" \
data-panel="'+panelId+'" data-row="'+originalIndex+'" data-di="'+k+'" \
value="'+esc(v)+'" maxlength="2" \
pattern="(0[1-9]|[12][0-9]|3[01])">\
    </div></td>';
}).join('');

const total  = calcAmount(panelId, row.dates);
const unpaid = calcUnpaid(panelId, row.dates, total);
groupTotal  += Number(total)||0;

htmlParts.push('<tr>\
  <td data-label="#">'+(htmlParts.length)+'</td>\
  <td data-label="氏名">'+esc(row.name)+'</td>\
  <td data-label="担当">'+esc(row.staff||'')+'</td>\
  '+dateCells+'\
  <td class="amount-cell" data-label="合計金額">¥'+fmtJPY.format(total)+'</td>\
  <td class="unpaid-cell" data-label="未払金額">¥'+fmtJPY.format(unpaid)+'</td>\
  <td data-label="操作"><button class="btn" data-action="del" data-index="'+originalIndex+'" data-panel="'+panelId+'">削除</button></td>\
</tr>');
      });

      // グループ小計行
      htmlParts.push('<tr class="group-subtotal"><td colspan="'+COLS+'">グループ合計金額：¥'+fmtJPY.format(groupTotal)+'</td></tr>');
    });

    tbody.innerHTML = htmlParts.join('');
    updateMainUnpaid(panelId.split('-')[0]);
    return;
  }

// === 通常タブ（タチバナ／ＯＺ／その他）は data-label を付与して描画 ===
tbody.innerHTML = data.map(function(row,i){
  const makeDateCells = (row.dates||[]).map(function(cell,k){
    const v = cell && (cell.md || isoToMD(cell.ymd||'')) || '';
    const checked = cell && cell.checked ? 'checked' : '';
    const tdCls   = cell && cell.checked ? 'date-td is-checked' : 'date-td';
    const label   = 'D'+(k+1);
    return '<td class="'+tdCls+'" data-label="'+label+'"><label class="date-wrap">\
      <input type="checkbox" class="day-check" data-panel="'+panelId+'" data-row="'+i+'" data-di="'+k+'" '+checked+'>\
      <input type="text" inputmode="numeric" placeholder="MM/DD" class="md-input" \
data-panel="'+panelId+'" data-row="'+i+'" data-di="'+k+'" value="'+esc(v)+'" maxlength="5" \
pattern="(0[1-9]|1[0-2])\\/(0[1-9]|[12][0-9]|3[01])">\
    </label></td>';
  }).join('');

  const total  = calcAmount(panelId, row.dates);
  const unpaid = calcUnpaid(panelId, row.dates, total);

  const buyCell    = (!isAdv && isSB) ? '<td class="buy-cell" data-label="買取金額">¥'+fmtJPY.format(Number(row.buy)||0)+'</td>' : '';
  const remainCell = (!isAdv && isSB) ? '<td class="remain-cell" data-label="残金">¥'+fmtJPY.format(calcRemain(row.buy, total))+'</td>' : '';

  return '<tr>\
    <td data-label="#">'+(i+1)+'</td>\
    <td data-label="氏名">'+esc(row.name)+'</td>\
    <td data-label="担当">'+esc(row.staff||'')+'</td>\
    '+buyCell+ makeDateCells +'\
    <td class="amount-cell" data-label="合計金額">¥'+fmtJPY.format(total)+'</td>\
    '+remainCell+'\
    <td class="unpaid-cell" data-label="未払金額">¥'+fmtJPY.format(unpaid)+'</td>\
    <td data-label="操作"><button class="btn" data-action="del" data-index="'+i+'" data-panel="'+panelId+'">削除</button></td>\
  </tr>';
}).join('');

  if(!isAdv){ ensureCompletedContainer(panelId); renderCompletedTable(panelId); }
  updateMainUnpaid(panelId.split('-')[0]);

// フィルタ用セレクトを更新
updateFilterOptions(panelId, data);

applyNameFilter(panelId);
}

function updateFilterOptions(panelId, data){
  const sel = document.querySelector('.filter-select[data-panel="'+panelId+'"]');
  if(!sel) return;
  const current = sel.value;
  sel.innerHTML = '<option value="">すべて表示</option>';
  const names = [...new Set(data.map(r=>r.name).filter(n=>!!n))];
  names.sort((a,b)=> a.localeCompare(b,'ja'));
  names.forEach(n=>{
    const opt = document.createElement('option');
    opt.value = n;
    opt.textContent = n;
    sel.appendChild(opt);
  });
  if(current && [...sel.options].some(o=>o.value===current)){
    sel.value = current;
  } else {
    sel.value = "";
  }
}

function applyNameFilter(panelId){
  const sel   = document.querySelector('.filter-select[data-panel="'+panelId+'"]');
  const table = document.querySelector('table.name-table[data-panel="'+panelId+'"]');
  if(!sel || !table) return;

  const keyword = sel.value.trim();
  const trs = table.querySelectorAll('tbody tr');

  trs.forEach(tr=>{
    const nameTd = tr.querySelector('td[data-label="氏名"]');
    if(!nameTd){
      // 在籍顧問の「グループ見出し／小計」行は、絞り込み中は非表示
      tr.style.display = (keyword==="" ? "" : "none");
      return;
    }
    const text = (nameTd.textContent||"").trim();
    tr.style.display = (keyword==="" || text===keyword) ? "" : "none";
  });
}

// ドロップダウンが変わったら適用
document.addEventListener('change',(e)=>{
  const sel = e.target.closest('.filter-select');
  if(!sel) return;
  applyNameFilter(sel.dataset.panel);
});

  // フォーム初期化
async function initForm(form){
  const panelId = form.dataset.panel;

  // === 在籍顧問フォームなら最後に選択したグループを復元 ===
  if (panelId === "tab4-sub1") {
    const groupEl = form.querySelector('select[name="group"]');
    if (groupEl) {
      const lastGroup = localStorage.getItem("lastAdvGroup");
      if (lastGroup) groupEl.value = lastGroup;
      // 選択変更ごとに保存
      groupEl.addEventListener("change", () => {
        localStorage.setItem("lastAdvGroup", groupEl.value);
      });
    }
  }

  renderTable(panelId);

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const nameEl  = form.querySelector('input[name="name"]');
    const buyEl   = form.querySelector('input[name="buy"]');
    const groupEl = form.querySelector('select[name="group"]');
    const staffEl = form.querySelector('input[name="staff"]');

    const name = (nameEl && nameEl.value || "").trim();
    if(!name) return;

    const buy  = Math.max(0, Number(buyEl && buyEl.value || 0));
    const data = normalizeData(await readNames(panelId));

    const row = {
      name,
      dates: Array(10).fill(0).map(()=>({md:"",ymd:"",checked:false}))
    };
    if(panelId.endsWith('sub2') && !isAdviser(panelId)) row.buy = buy;
    if(isAdviser(panelId) && groupEl) {
      row.group = String(groupEl.value || "");
      localStorage.setItem("lastAdvGroup", row.group); // ← 追加：submit時にも保存
    }
    if(staffEl) row.staff = String(staffEl.value || "");

    data.push(row);
    saveNames(panelId, data);

    form.reset();
    renderTable(panelId);

    // 氏名入力欄にフォーカス戻す
    if(nameEl) nameEl.focus();

    // === form.reset()で<select>も初期化されるので復元 ===
    if (isAdviser(panelId) && groupEl) {
      const lastGroup = localStorage.getItem("lastAdvGroup");
      if (lastGroup) groupEl.value = lastGroup;
    }
  });
}

// 「買取終了」→ アクティブへ戻す
document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action="restore"]');
  if(!btn) return;

  const panelId = btn.dataset.panel;         // 例: "tab1-sub2"
  const idx     = Number(btn.dataset.index); // 買取終了側の行インデックス

  // 完了一覧（買取終了）から対象を取得
  const completed = normalizeData(await readCompleted(panelId));
  const row = completed[idx];
  if(!row) return;

  // アクティブ側へ移動
  const active = normalizeData(await readNames(panelId));
  active.push(row);
  completed.splice(idx, 1);

  // 保存 & 再描画
  saveNames(panelId, active);
  saveCompleted(panelId, completed);
  renderTable(panelId);
  renderCompletedTable(panelId);
});

document.querySelectorAll('form.name-form').forEach(initForm);
document.querySelectorAll('form.name-form').forEach(enableEnterTabbing);


  // 削除（アクティブ）※確認ダイアログ付き
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-action="del"]');
    if(!btn) return;
    const panelId = btn.dataset.panel; 
    const idx = Number(btn.dataset.index);
    const data = normalizeData(await readNames(panelId));
    const row = data[idx];
    const name = row?.name ? `「${row.name}」` : `No.${idx+1}`;
    if(!window.confirm(`${name} を削除します。よろしいですか？`)) return;
    data.splice(idx,1); 
    saveNames(panelId, data);
    renderTable(panelId); 
    if(!isAdviser(panelId)) renderCompletedTable(panelId);
  });

  // 削除（完了テーブル）※確認ダイアログ付き
document.addEventListener('click', async (e)=>{   // ★ async を追加
  const btn = e.target.closest('button[data-action="cdel"]');
  if(!btn) return;
  const panelId = btn.dataset.panel; 
  const idx = Number(btn.dataset.index);
  const data = normalizeData(await readCompleted(panelId)); // ← await 使える
  const row = data[idx];
  const name = row?.name ? `「${row.name}」` : `No.${idx+1}`;
  if(!window.confirm(`${name} を完了一覧から削除します。よろしいですか？`)) return;
  data.splice(idx,1);
  saveCompleted(panelId, data);
  renderCompletedTable(panelId);
});

  // モーダル（買取金額一括編集：tab1-3 の SB）
  async function openBuyEditor(panelId){
    const modal = document.getElementById('buy-editor-modal');
    const list = modal.querySelector('.buy-list');
    const title = modal.querySelector('[data-title]');
    title.textContent = '買取金額を編集（'+panelId+'）';
    list.innerHTML = '';
    const data = normalizeData(await readNames(panelId));
    data.forEach((row, i)=>{
      const nameDiv = document.createElement('div'); nameDiv.className='name'; nameDiv.textContent = row.name || ('No.'+(i+1));
      const inp = document.createElement('input'); inp.type='number'; inp.min='0'; inp.value=Number(row.buy)||0; inp.dataset.index=String(i);
      list.appendChild(nameDiv); list.appendChild(inp);
    });
    modal.dataset.panel = panelId;
    modal.classList.add('show');
  }
  document.addEventListener('click', async (e)=>{
    const editBtn = e.target.closest('.edit-buy-btn');
    if(editBtn){ openBuyEditor(editBtn.dataset.panel); return; }
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ document.getElementById('buy-editor-modal').classList.remove('show'); return; }
  });
  document.addEventListener('click', async (e)=>{
    const saveBtn = e.target.closest('[data-save]');
    if(!saveBtn) return;
    const modal = document.getElementById('buy-editor-modal');
    const panel = modal.dataset.panel; if(!panel) return;
    const data = normalizeData(await readNames(panel));
    const inputs = modal.querySelectorAll('.buy-list input');
    inputs.forEach((inp)=>{ const idx=Number(inp.dataset.index); if(data[idx]) data[idx].buy=Math.max(0, Number(inp.value)||0); });
    saveNames(panel, data); modal.classList.remove('show'); renderTable(panel);
  });
  // modal close gestures
  document.addEventListener('click', async (e)=>{
    const modal = document.getElementById('buy-editor-modal');
    if(!modal.classList.contains('show')) return;
    if(e.target.classList.contains('backdrop')) modal.classList.remove('show');
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ const m=document.getElementById('buy-editor-modal'); if(m.classList.contains('show')) m.classList.remove('show'); }
  });

  // チェック切替（在籍以外のみチェックあり & 完了移動）
  document.addEventListener('change', async (e)=>{
    const cb = e.target.closest('input.day-check');
    if(!cb) return;
    const panelId = cb.dataset.panel; if(isAdviser(panelId)) return; // 在籍はチェックボックス自体なし
    const r=Number(cb.dataset.row), k=Number(cb.dataset.di);
    const data = normalizeData(await readNames(panelId)); if(!data[r]) return;
    data[r].dates[k].checked = cb.checked;

    const checkedCount = (data[r].dates||[]).filter(d=> !!d.checked).length;
    if(checkedCount===10){
      const completed = normalizeData(await readCompleted(panelId));
      completed.push(data[r]);
      data.splice(r,1);
      saveNames(panelId, data); saveCompleted(panelId, completed);
    } else {
      saveNames(panelId, data);
    }
    renderTable(panelId); renderCompletedTable(panelId);
  });

  // メインタブ切替
  document.querySelectorAll('header .tab-btn').forEach((btn)=>{
    btn.addEventListener('click', (e)=>{
      const tab = e.currentTarget.dataset.tab;
      document.querySelectorAll('header .tab-btn').forEach((b)=> b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
      MAIN_TABS.forEach((id)=>{ const p = document.getElementById(id); if(p) p.classList.toggle('active', id===tab); });
    });
  });

  // サブタブ切替
  document.querySelectorAll('main section.panel nav.tabs .tab-btn').forEach((btn)=>{
    btn.addEventListener('click', (e)=>{
      const parentPanel = e.currentTarget.closest('section.panel');
      const subPanels = parentPanel.querySelectorAll(':scope > section.panel');
      const subBtns = parentPanel.querySelectorAll(':scope > nav.tabs .tab-btn');
      subBtns.forEach((b)=> b.setAttribute('aria-selected','false'));
      e.currentTarget.setAttribute('aria-selected','true');
      subPanels.forEach((sp)=> sp.classList.toggle('active', sp.id===e.currentTarget.dataset.tab));
    });
  });

  // 完了テーブル（土台生成 / 在籍は使わない）
  function ensureCompletedContainer(panelId){
    if(isAdviser(panelId)) return;
    const baseTable = document.querySelector('table.name-table[data-panel="'+panelId+'"]');
    if(!baseTable) return;
    const panel = baseTable.closest('section.panel');
    if(!panel) return;
    let wrap = panel.querySelector('.completed-wrap[data-panel="'+panelId+'"]');
    if(wrap) return;

    wrap = document.createElement('div'); wrap.className='completed-wrap'; wrap.dataset.panel=panelId;
    const title = document.createElement('h4'); title.textContent='買取終了'; wrap.appendChild(title);
    const tw = document.createElement('div'); tw.className='table-wrap'; wrap.appendChild(tw);
    const tbl = document.createElement('table'); tbl.className='completed-table'; tbl.setAttribute('data-panel', panelId);
    const thead = document.createElement('thead'); const tbody=document.createElement('tbody');
    tbl.appendChild(thead); tbl.appendChild(tbody);
    const isSB = panelId.endsWith('sub2');
    const headHtml = '<tr>\
      <th>#</th><th>氏名</th><th>担当</th>' + (isSB ? '<th>買取金額</th>' : '') + '\
      <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>\
      <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>\
      <th>合計金額</th>' + (isSB ? '<th>残金</th>' : '') + '\
      <th>未払金額</th><th>操作</th>\
    </tr>';
    thead.innerHTML = headHtml;
    tw.appendChild(tbl);
    panel.appendChild(wrap);
  }

  // 完了テーブル描画（在籍は使わない）
async function renderCompletedTable(panelId){
  if(isAdviser(panelId)) return;
  ensureCompletedContainer(panelId);
  const tbl = document.querySelector('table.completed-table[data-panel="'+panelId+'"]');
  if(!tbl) return;
  const tbody = tbl.querySelector('tbody');
  const data = normalizeData(await readCompleted(panelId));
  const isSB = panelId.endsWith('sub2');

tbody.innerHTML = data.map((row,i)=>{
  const buyCell = isSB ? '<td class="buy-cell">¥'+fmtJPY.format(Number(row.buy)||0)+'</td>' : '';
  const dateCells = (row.dates||[]).map((cell)=>{
    const v = cell && (cell.md || isoToMD(cell.ymd||"")) || "";
    const tdCls = cell && cell.checked ? 'date-td is-checked' : 'date-td';
    return '<td class="'+tdCls+'"><div class="date-wrap">\
      <input type="checkbox" class="day-check" disabled '+(cell&&cell.checked?'checked':'')+'>\
      <input type="text" class="md-input" value="'+esc(v)+'" disabled>\
    </div></td>';
  }).join("");
  const total = calcAmount(panelId, row.dates||[]);
  const unpaid = calcUnpaid(panelId, row.dates||[], total);
  const remainCell = isSB ? '<td class="remain-cell">¥'+fmtJPY.format(calcRemain(row.buy, total))+'</td>' : '';

  return '<tr>\
    <td>'+(i+1)+'</td>\
    <td>'+esc(row.name)+'</td>\
    <td>'+esc(row.staff||'')+'</td>\
    '+buyCell+dateCells+'\
    <td class="amount-cell">¥'+fmtJPY.format(total)+'</td>'+remainCell+'\
    <td class="unpaid-cell">¥'+fmtJPY.format(unpaid)+'</td>\
    <td><button class="btn" data-action="restore" data-index="'+i+'" data-panel="'+panelId+'">戻す</button>\
        <button class="btn" data-action="cdel" data-index="'+i+'" data-panel="'+panelId+'">削除</button></td>\
  </tr>';
}).join("");
}

  // 初期トータル
  MAIN_TABS.forEach(updateMainUnpaid);
  updateOverallUnpaid();

  // パネルごとにリアルタイム監視
function subscribePanel(panelId) {
  panelDoc(panelId).onSnapshot((doc) => {
    if(doc.exists){
      renderTable(panelId);  // ★ normalizeData(...) を渡さずに呼ぶ
    }
  });
}

// 初期化時に全部登録
MAIN_TABS.forEach(tab => {
  subscribePanel(tab+'-sub1');
  if (tab !== 'tab4') subscribePanel(tab+'-sub2');
});

</script>
</body>
</html>
