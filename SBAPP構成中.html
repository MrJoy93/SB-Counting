<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Multi-Tab App</title>
<style>
  :root{
    --brand:#00f5ff; --panel:rgba(30,38,60,.78); --text:#eaf6ff; --muted:#97e4f5;
    --checked-bg: rgba(0,245,255,.14); --checked-border: rgba(0,245,255,.55);
  }
  *{box-sizing:border-box}
  body{margin:0;background:#121826;color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"M PLUS 2",sans-serif}
  header{position:sticky;top:0;background:#1a2134;border-bottom:1px solid rgba(0,245,255,.25);padding:10px 16px;z-index:50}
  header h1{margin:0;font-size:16px}
  .tabs-bar{display:flex;align-items:center;gap:12px}
  header .tabs{flex:1}
  nav.tabs{display:flex;gap:8px;align-items:center;margin-top:8px;overflow-x:auto}
  .tab-btn{appearance:none;border:1px solid rgba(0,245,255,.35);background:#141a2a;color:#b9e9f5;padding:8px 14px;border-radius:10px;cursor:pointer}
  .tab-btn[aria-selected="true"]{color:#00f5ff;border-color:#00f5ff}
  .overall-unpaid{margin-left:auto;font-weight:700;color:#eaf6ff;background:rgba(0,245,255,.16);border:1px solid rgba(0,245,255,.35);padding:6px 10px;border-radius:10px;white-space:nowrap}

  main{max-width:none;margin:16px auto 48px;padding:0 12px}
  .panel{display:none;background:var(--panel);border:1px solid rgba(0,245,255,.18);border-radius:12px;padding:14px}
  .panel.active{display:block}
  .heading{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:0 0 8px}
  .main-unpaid{font-weight:700;color:#eaf6ff;background:rgba(0,245,255,.12);border:1px solid rgba(0,245,255,.35);padding:6px 10px;border-radius:10px;white-space:nowrap}

  .name-form{margin:6px 0 10px;padding:10px;border:1px solid rgba(0,245,255,.22);border-radius:10px;background:rgba(16,24,40,.55)}
  .label{font-size:12px;color:var(--muted);letter-spacing:.12em;display:inline-block;margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input, input{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,245,255,.35);background:#273a57;color:#eaf6ff}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,245,255,.35);background:#1c2a4a;color:#eaf6ff;cursor:pointer}

  .table-wrap{width:100%;overflow-x:auto}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#162038;border-radius:12px;table-layout:fixed;font-size:14px}
  th,td{white-space:nowrap;border-bottom:1px solid rgba(0,245,255,.25);padding:6px}
  th{background:#20365a;color:#00f5ff}
  tr:last-child td{border-bottom:none}

  /* widths */
  table th:first-child, table td:first-child{width:44px}
  table th:nth-child(2), table td:nth-child(2){min-width:110px;max-width:160px;overflow:hidden;text-overflow:ellipsis}
  table th:last-child, table td:last-child{width:96px}
  .amount-cell,.unpaid-cell,.remain-cell{min-width:100px;text-align:right;font-weight:bold}

  .date-td{transition:background .18s ease, box-shadow .18s ease}
  .date-td.is-checked{background:var(--checked-bg);box-shadow:inset 0 0 0 1px var(--checked-border)}
  .date-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;padding:2px 0}
  .day-check{width:18px;height:18px;accent-color:var(--brand)}
  .md-input{width:72px;text-align:center}
  .md-input.invalid{border-color:#f43f5e;box-shadow:0 0 8px rgba(244,63,94,.35)}

  .buy-cell{text-align:right}
  .completed-wrap{margin-top:14px}
  .completed-wrap h4{margin:8px 0 6px;font-size:14px;color:#9fb9c9}

  /* modal for SB buy editing (tab1-3 only) */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1000}
  .modal.show{display:flex}
  .modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
  .modal .dialog{position:relative;background:#0f172a;border:1px solid rgba(0,245,255,.25);border-radius:12px;min-width:320px;max-width:640px;width:90%;padding:14px}
  .modal h4{margin:0 0 8px;font-size:16px}
  .buy-list{display:grid;grid-template-columns:1fr 140px;gap:8px;max-height:50vh;overflow:auto;margin:8px 0}
  .buy-list .name{align-self:center;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .buy-list input{width:100%}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
</style>
</head>
<body>
<header>
  <h1>新規 Web アプリ</h1>
  <div class="tabs-bar">
    <nav class="tabs" aria-label="Main Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab1">タチバナ</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab2">ＯＺ</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab3">その他</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab4">在籍顧問</button>
    </nav>
    <div class="overall-unpaid" id="overall-unpaid" aria-live="polite">総未払合計: ¥0</div>
  </div>
</header>

<main>
  <!-- ===== タチバナ ===== -->
  <section id="tab1" class="panel active">
    <div class="heading">
      <h2>タチバナ</h2>
      <div class="main-unpaid" data-main="tab1" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="タチバナ Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab1-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab1-sub2">SB</button>
    </nav>

    <!-- 足代 -->
    <section id="tab1-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab1-sub1">
        <label class="label" for="tab1-sub1-name">氏名</label>
        <div class="row">
          <input id="tab1-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab1-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SB -->
    <section id="tab1-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab1-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab1-sub2">
        <label class="label" for="tab1-sub2-name">氏名</label>
        <div class="row">
          <input id="tab1-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input id="tab1-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab1-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== ＯＺ ===== -->
  <section id="tab2" class="panel">
    <div class="heading">
      <h2>ＯＺ</h2>
      <div class="main-unpaid" data-main="tab2" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="ＯＺ Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab2-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab2-sub2">SB</button>
    </nav>

    <section id="tab2-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab2-sub1">
        <label class="label" for="tab2-sub1-name">氏名</label>
        <div class="row">
          <input id="tab2-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab2-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab2-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab2-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab2-sub2">
        <label class="label" for="tab2-sub2-name">氏名</label>
        <div class="row">
          <input id="tab2-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input id="tab2-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab2-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== その他 ===== -->
  <section id="tab3" class="panel">
    <div class="heading">
      <h2>その他</h2>
      <div class="main-unpaid" data-main="tab3" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="その他 Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab3-sub1">足代</button>
      <button class="tab-btn" aria-selected="false" data-tab="tab3-sub2">SB</button>
    </nav>

    <section id="tab3-sub1" class="panel active">
      <h3>足代</h3>
      <form class="name-form" data-panel="tab3-sub1">
        <label class="label" for="tab3-sub1-name">氏名</label>
        <div class="row">
          <input id="tab3-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab3-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>

    <section id="tab3-sub2" class="panel">
      <div class="row" style="margin:6px 0;">
        <button class="btn edit-buy-btn" data-panel="tab3-sub2" type="button">買取金額を編集</button>
      </div>
      <form class="name-form" data-panel="tab3-sub2">
        <label class="label" for="tab3-sub2-name">氏名</label>
        <div class="row">
          <input id="tab3-sub2-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
          <input id="tab3-sub2-buy" type="number" class="input" name="buy" placeholder="買取金額" min="0">
          <button class="btn" type="submit">追加</button>
        </div>
      </form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab3-sub2">
          <thead>
            <tr>
              <th>#</th><th>氏名</th><th>買取金額</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>残金</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>

  <!-- ===== 在籍顧問 ===== -->
  <section id="tab4" class="panel">
    <div class="heading">
      <h2>在籍顧問</h2>
      <div class="main-unpaid" data-main="tab4" aria-live="polite">未払合計: ¥0</div>
    </div>
    <nav class="tabs" aria-label="在籍顧問 Sub Tabs">
      <button class="tab-btn" aria-selected="true" data-tab="tab4-sub1">足代</button>
    </nav>

<form class="name-form" data-panel="tab4-sub1">
  <label class="label" for="tab4-sub1-name">氏名</label>
  <div class="row">
    <input id="tab4-sub1-name" type="text" class="input" name="name" placeholder="氏名を入力" required>
    <select class="input" name="group" aria-label="グループ選択">
      <option value="tab1">タチバナ</option>
      <option value="tab2">ＯＺ</option>
      <option value="tab3">その他</option>
    </select>
    <button class="btn" type="submit">追加</button>
  </div>
</form>
      <div class="table-wrap">
        <table class="name-table" data-panel="tab4-sub1">
          <thead>
            <tr>
              <th>#</th><th>氏名</th>
              <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>
              <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>
              <th>合計金額</th><th>未払金額</th><th>操作</th>
            </tr>
          </thead><tbody></tbody>
        </table>
      </div>
    </section>
  </section>
</main>

<!-- modal: SB buy editor -->
<div class="modal" id="buy-editor-modal" aria-hidden="true" role="dialog">
  <div class="backdrop" data-close></div>
  <div class="dialog" role="document">
    <h4 data-title>買取金額を編集</h4>
    <div class="buy-list" aria-label="買取金額の一覧"></div>
    <div class="actions">
      <button class="btn" data-close type="button">キャンセル</button>
      <button class="btn" data-save type="button">保存</button>
    </div>
  </div>
</div>

<script>
(function(){
  const MAIN_TABS = ["tab1","tab2","tab3","tab4"];
  const fmtJPY = new Intl.NumberFormat('ja-JP');
  const MD_RE = /^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])$/;

  function keyFor(panelId){ return 'names_' + panelId; }
  function readNames(panelId){ try{ return JSON.parse(localStorage.getItem(keyFor(panelId))||"[]"); }catch{ return []; } }
  function saveNames(panelId, arr){ try{ localStorage.setItem(keyFor(panelId), JSON.stringify(arr)); }catch{} }

  function keyCompleted(panelId){ return 'completed_'+panelId; }
  function readCompleted(panelId){ try{ return JSON.parse(localStorage.getItem(keyCompleted(panelId))||"[]"); }catch{ return []; } }
  function saveCompleted(panelId, arr){ try{ localStorage.setItem(keyCompleted(panelId), JSON.stringify(arr)); }catch{} }

  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function parseMD(txt){ const t=(txt||"").trim(); const m=t.match(MD_RE); return m? {mm:m[1],dd:m[2]}:null; }
  function isoToMD(iso){ if(!iso) return ""; const m=String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/); return m? (m[2]+"/"+m[3]) : ""; }
  function mdToISO(md, year){ return md? (year+"-"+md.mm+"-"+md.dd) : ""; }
  function inferYear(){ return new Date().getFullYear(); }

function normalizeData(raw){
  const toObj = (v)=>{
    let md="", ymd="", checked=false;
    if(typeof v==='string'){
      if(/^\d{4}-\d{2}-\d{2}$/.test(v)){ ymd=v; md=isoToMD(v); }
      else if(MD_RE.test(v)){ md=v; }
    } else if(v && typeof v==='object'){
      md = v.md || isoToMD(v.ymd||"");
      ymd = v.ymd || "";
      checked = !!v.checked;
    }
    return { md, ymd, checked };
  };
  return (raw||[]).map(item=>{
    const name = item?.name || (typeof item==='string'? item : "");
    const buy = Number(item?.buy||0);
    const group = item?.group ? String(item.group) : ""; // 在籍顧問用
    let dates = item?.dates||[]; if(!Array.isArray(dates)) dates=[];
    dates = dates.slice(0,10).map(toObj); while(dates.length<10) dates.push({md:"",ymd:"",checked:false});
    return { name, buy, group, dates };
  });
}

  function isAdviser(panelId){ return String(panelId||'').indexOf('tab4')===0; }

  // 合計金額
  function calcAmount(panelId, dates){
    const filled = (dates||[]).filter(d=> d && d.md).length;
    if(isAdviser(panelId)){
      // 在籍顧問：10日到達で一律 20,000
      return filled>=10 ? 20000 : 0;
    }
    return panelId.endsWith('sub1') ? filled*5000 : panelId.endsWith('sub2') ? filled*20000 : 0;
  }

  // 未払金額
  function calcUnpaid(panelId, dates, total){
    if(isAdviser(panelId)){
      // 在籍顧問：控除なし → 未払＝発生額
      return Math.max(0, Number(total)||0);
    }
    const checkedCount = (dates||[]).filter(d=> !!d.checked).length;
    let unpaid = 0;
    if(panelId.endsWith('sub1')) unpaid = total - checkedCount*5000;
    if(panelId.endsWith('sub2')) unpaid = total - checkedCount*20000;
    return Math.max(0, unpaid);
  }

  function calcRemain(buy, total){ return Math.max(0, (Number(buy)||0) - total); }

  // タブ別未払合計
  function sumUnpaidForData(panelId, data){
    const isSB = panelId.endsWith('sub2');
    const isAdv = isAdviser(panelId);
    return (data||[]).reduce((acc,row)=>{
      const total  = calcAmount(panelId, row.dates||[]);
      const unpaid = calcUnpaid(panelId, row.dates||[], total);
      if(!isAdv && isSB){
        // 通常SB：買取金額−合計＝0 の行のみ未払合計に入れる
        const rawRemain = (Number(row.buy)||0) - total;
        if(rawRemain !== 0) return acc;
      }
      return acc + unpaid;
    }, 0);
  }

  function updateMainUnpaid(mainId){
    const badge = document.querySelector('.main-unpaid[data-main="'+mainId+'"]');
    if(!badge) return;
    const d1 = normalizeData(readNames(mainId+'-sub1'));
    const d2 = normalizeData(readNames(mainId+'-sub2'));
    const sum = sumUnpaidForData(mainId+'-sub1', d1) + sumUnpaidForData(mainId+'-sub2', d2);
    badge.textContent = '未払合計: ¥'+fmtJPY.format(sum);
    updateOverallUnpaid();
  }

  function updateOverallUnpaid(){
    const el = document.getElementById('overall-unpaid');
    if(!el) return;
    let grand = 0;
    for(const mid of MAIN_TABS){
      const d1 = normalizeData(readNames(mid+'-sub1'));
      const d2 = normalizeData(readNames(mid+'-sub2'));
      grand += sumUnpaidForData(mid+'-sub1', d1) + sumUnpaidForData(mid+'-sub2', d2);
    }
    el.textContent = '総未払合計: ¥'+fmtJPY.format(grand);
  }

  // テーブル描画
function renderTable(panelId){
  const table = document.querySelector('table.name-table[data-panel="'+panelId+'"]');
  const tbody = table && table.querySelector('tbody'); if(!tbody) return;
  const data = normalizeData(readNames(panelId));
  const isSB = panelId.endsWith('sub2');
  const isAdv = isAdviser(panelId);

  function groupLabel(id){
    return id==='tab1'?'タチバナ': id==='tab2'?'ＯＺ': id==='tab3'?'その他':'';
  }

  tbody.innerHTML = data.map((row,i)=>{
    const buyCell = (!isAdv && isSB) ? '<td class="buy-cell">¥'+fmtJPY.format(Number(row.buy)||0)+'</td>' : '';
    const groupCell = isAdv ? '<td>'+esc(groupLabel(row.group||""))+'</td>' : '';
    const dateCells = (row.dates||[]).map((cell,k)=>{
      const v = cell && (cell.md || isoToMD(cell.ymd||"")) || "";
      if(isAdv){
        return '<td class="date-td"><div class="date-wrap">\
          <input type="text" inputmode="numeric" placeholder="MM/DD" class="md-input" data-panel="'+panelId+'" data-row="'+i+'" data-di="'+k+'" value="'+esc(v)+'" maxlength="5" pattern="(0[1-9]|1[0-2])\\/(0[1-9]|[12][0-9]|3[01])">\
        </div></td>';
      } else {
        const checked = cell && cell.checked ? 'checked' : '';
        const tdCls = cell && cell.checked ? 'date-td is-checked' : 'date-td';
        return '<td class="'+tdCls+'"><label class="date-wrap">\
          <input type="checkbox" class="day-check" data-panel="'+panelId+'" data-row="'+i+'" data-di="'+k+'" '+checked+'>\
          <input type="text" inputmode="numeric" placeholder="MM/DD" class="md-input" data-panel="'+panelId+'" data-row="'+i+'" data-di="'+k+'" value="'+esc(v)+'" maxlength="5" pattern="(0[1-9]|1[0-2])\\/(0[1-9]|[12][0-9]|3[01])">\
        </label></td>';
      }
    }).join("");

    const total = calcAmount(panelId, row.dates);
    const unpaid = calcUnpaid(panelId, row.dates, total);
    const remainCell = (!isAdv && isSB) ? '<td class="remain-cell">¥'+fmtJPY.format(calcRemain(row.buy, total))+'</td>' : '';

    return '<tr>\
      <td>'+(i+1)+'</td>\
      <td>'+esc(row.name)+'</td>\
      '+groupCell+'\
      '+buyCell+dateCells+'\
      <td class="amount-cell">¥'+fmtJPY.format(total)+'</td>\
      '+remainCell+'\
      <td class="unpaid-cell">¥'+fmtJPY.format(unpaid)+'</td>\
      <td><button class="btn" data-action="del" data-index="'+i+'" data-panel="'+panelId+'">削除</button></td>\
    </tr>';
  }).join("");

  if(!isAdv){ ensureCompletedContainer(panelId); renderCompletedTable(panelId); }
  updateMainUnpaid(panelId.split('-')[0]);
}


  // フォーム初期化
function initForm(form){
  const panelId = form.dataset.panel;
  renderTable(panelId);
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const nameEl  = form.querySelector('input[name="name"]');
    const buyEl   = form.querySelector('input[name="buy"]');
    const groupEl = form.querySelector('select[name="group"]'); // ★ グループ選択追加

    const name = (nameEl && nameEl.value || "").trim();
    if(!name) return;

    const buy = Math.max(0, Number(buyEl && buyEl.value || 0));
    const data = normalizeData(readNames(panelId));

    const row = { 
      name, 
      dates: Array(10).fill(0).map(()=>({md:"",ymd:"",checked:false})) 
    };

    // SBの場合（在籍顧問以外）
    if(panelId.endsWith('sub2') && !isAdviser(panelId)) {
      row.buy = buy;
    }

    // 在籍顧問の場合は group を保存
    if(isAdviser(panelId) && groupEl){
      row.group = String(groupEl.value || "");
    }

    data.push(row);
    saveNames(panelId, data);
    form.reset();
    renderTable(panelId);
  });
}
document.querySelectorAll('form.name-form').forEach(initForm);


  // 削除（アクティブ）
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-action="del"]');
    if(!btn) return;
    const panelId = btn.dataset.panel; const idx = Number(btn.dataset.index);
    const data = normalizeData(readNames(panelId));
    data.splice(idx,1); saveNames(panelId, data);
    renderTable(panelId); if(!isAdviser(panelId)) renderCompletedTable(panelId);
  });

  // モーダル（買取金額一括編集：tab1-3 の SB）
  function openBuyEditor(panelId){
    const modal = document.getElementById('buy-editor-modal');
    const list = modal.querySelector('.buy-list');
    const title = modal.querySelector('[data-title]');
    title.textContent = '買取金額を編集（'+panelId+'）';
    list.innerHTML = '';
    const data = normalizeData(readNames(panelId));
    data.forEach((row, i)=>{
      const nameDiv = document.createElement('div'); nameDiv.className='name'; nameDiv.textContent = row.name || ('No.'+(i+1));
      const inp = document.createElement('input'); inp.type='number'; inp.min='0'; inp.value=Number(row.buy)||0; inp.dataset.index=String(i);
      list.appendChild(nameDiv); list.appendChild(inp);
    });
    modal.dataset.panel = panelId;
    modal.classList.add('show');
  }
  document.addEventListener('click', (e)=>{
    const editBtn = e.target.closest('.edit-buy-btn');
    if(editBtn){ openBuyEditor(editBtn.dataset.panel); return; }
    const closeBtn = e.target.closest('[data-close]');
    if(closeBtn){ document.getElementById('buy-editor-modal').classList.remove('show'); return; }
  });
  document.addEventListener('click', (e)=>{
    const saveBtn = e.target.closest('[data-save]');
    if(!saveBtn) return;
    const modal = document.getElementById('buy-editor-modal');
    const panel = modal.dataset.panel; if(!panel) return;
    const data = normalizeData(readNames(panel));
    const inputs = modal.querySelectorAll('.buy-list input');
    inputs.forEach((inp)=>{ const idx=Number(inp.dataset.index); if(data[idx]) data[idx].buy=Math.max(0, Number(inp.value)||0); });
    saveNames(panel, data); modal.classList.remove('show'); renderTable(panel);
  });
  // modal close gestures
  document.addEventListener('click', (e)=>{
    const modal = document.getElementById('buy-editor-modal');
    if(!modal.classList.contains('show')) return;
    if(e.target.classList.contains('backdrop')) modal.classList.remove('show');
  });
  document.addEventListener('keydown', (e)=>{
    if(e.key==='Escape'){ const m=document.getElementById('buy-editor-modal'); if(m.classList.contains('show')) m.classList.remove('show'); }
  });

  // チェック切替（在籍以外のみチェックあり & 完了移動）
  document.addEventListener('change', (e)=>{
    const cb = e.target.closest('input.day-check');
    if(!cb) return;
    const panelId = cb.dataset.panel; if(isAdviser(panelId)) return; // 在籍はチェックボックス自体なし
    const r=Number(cb.dataset.row), k=Number(cb.dataset.di);
    const data = normalizeData(readNames(panelId)); if(!data[r]) return;
    data[r].dates[k].checked = cb.checked;

    const checkedCount = (data[r].dates||[]).filter(d=> !!d.checked).length;
    if(checkedCount===10){
      const completed = normalizeData(readCompleted(panelId));
      completed.push(data[r]);
      data.splice(r,1);
      saveNames(panelId, data); saveCompleted(panelId, completed);
    } else {
      saveNames(panelId, data);
    }
    renderTable(panelId); renderCompletedTable(panelId);
  });

  // MM/DD auto-format（入力中はエラーにしない）
  document.addEventListener('input', (e)=>{
    const el = e.target.closest('input.md-input'); if(!el) return;
    let v = el.value.replace(/[^0-9]/g,"");
    if(v.length>4) v=v.slice(0,4);
    if(v.length>=3) v=v.slice(0,2)+"/"+v.slice(2);
    el.value=v;
    if(v==="" || MD_RE.test(v)) el.classList.remove('invalid');
  });
  // MM/DD save（空は許容・既存チェック保持）
  document.addEventListener('change', (e)=>{
    const el = e.target.closest('input.md-input'); if(!el) return;
    const panelId = el.dataset.panel; const r=Number(el.dataset.row), k=Number(el.dataset.di);
    const data = normalizeData(readNames(panelId)); if(!data[r]) return;
    const raw = (el.value||"").trim();
    if(raw === ""){
      el.classList.remove('invalid');
      const wasChecked = !!(data[r].dates[k] && data[r].dates[k].checked);
      data[r].dates[k] = { md:"", ymd:"", checked: wasChecked };
      saveNames(panelId, data); renderTable(panelId);
      return;
    }
    const md = parseMD(raw);
    if(!md){ el.classList.add('invalid'); return; }
    el.classList.remove('invalid');
    const yyyy = inferYear();
    const wasChecked = !!(data[r].dates[k] && data[r].dates[k].checked);
    data[r].dates[k] = { md:(md.mm+"/"+md.dd), ymd: mdToISO(md, yyyy), checked: wasChecked };
    saveNames(panelId, data); renderTable(panelId);
  });

  // メインタブ切替
  document.querySelectorAll('header .tab-btn').forEach((btn)=>{
    btn.addEventListener('click', (e)=>{
      const tab = e.currentTarget.dataset.tab;
      document.querySelectorAll('header .tab-btn').forEach((b)=> b.setAttribute('aria-selected', String(b.dataset.tab===tab)));
      MAIN_TABS.forEach((id)=>{ const p = document.getElementById(id); if(p) p.classList.toggle('active', id===tab); });
    });
  });

  // サブタブ切替
  document.querySelectorAll('main section.panel nav.tabs .tab-btn').forEach((btn)=>{
    btn.addEventListener('click', (e)=>{
      const parentPanel = e.currentTarget.closest('section.panel');
      const subPanels = parentPanel.querySelectorAll(':scope > section.panel');
      const subBtns = parentPanel.querySelectorAll(':scope > nav.tabs .tab-btn');
      subBtns.forEach((b)=> b.setAttribute('aria-selected','false'));
      e.currentTarget.setAttribute('aria-selected','true');
      subPanels.forEach((sp)=> sp.classList.toggle('active', sp.id===e.currentTarget.dataset.tab));
    });
  });

  // 完了テーブル（土台生成 / 在籍は使わない）
  function ensureCompletedContainer(panelId){
    if(isAdviser(panelId)) return;
    const baseTable = document.querySelector('table.name-table[data-panel="'+panelId+'"]');
    if(!baseTable) return;
    const panel = baseTable.closest('section.panel');
    if(!panel) return;
    let wrap = panel.querySelector('.completed-wrap[data-panel="'+panelId+'"]');
    if(wrap) return;

    wrap = document.createElement('div'); wrap.className='completed-wrap'; wrap.dataset.panel=panelId;
    const title = document.createElement('h4'); title.textContent='買取終了'; wrap.appendChild(title);
    const tw = document.createElement('div'); tw.className='table-wrap'; wrap.appendChild(tw);
    const tbl = document.createElement('table'); tbl.className='completed-table'; tbl.setAttribute('data-panel', panelId);
    const thead = document.createElement('thead'); const tbody=document.createElement('tbody');
    tbl.appendChild(thead); tbl.appendChild(tbody);
    const isSB = panelId.endsWith('sub2');
    const headHtml = '<tr>\
      <th>#</th><th>氏名</th>' + (isSB ? '<th>買取金額</th>' : '') + '\
      <th>D1</th><th>D2</th><th>D3</th><th>D4</th><th>D5</th>\
      <th>D6</th><th>D7</th><th>D8</th><th>D9</th><th>D10</th>\
      <th>合計金額</th>' + (isSB ? '<th>残金</th>' : '') + '\
      <th>未払金額</th><th>操作</th>\
    </tr>';
    thead.innerHTML = headHtml;
    tw.appendChild(tbl);
    panel.appendChild(wrap);
  }

  // 完了テーブル描画（在籍は使わない）
  function renderCompletedTable(panelId){
    if(isAdviser(panelId)) return;
    ensureCompletedContainer(panelId);
    const tbl = document.querySelector('table.completed-table[data-panel="'+panelId+'"]'); if(!tbl) return;
    const tbody = tbl.querySelector('tbody');
    const data = normalizeData(readCompleted(panelId));
    const isSB = panelId.endsWith('sub2');

    tbody.innerHTML = data.map((row,i)=>{
      const buyCell = isSB ? '<td class="buy-cell">¥'+fmtJPY.format(Number(row.buy)||0)+'</td>' : '';
      const dateCells = (row.dates||[]).map((cell)=>{
        const v = cell && (cell.md || isoToMD(cell.ymd||"")) || "";
        const tdCls = cell && cell.checked ? 'date-td is-checked' : 'date-td';
        return '<td class="'+tdCls+'"><div class="date-wrap">\
          <input type="checkbox" class="day-check" disabled '+(cell&&cell.checked?'checked':'')+'>\
          <input type="text" class="md-input" value="'+esc(v)+'" disabled>\
        </div></td>';
      }).join("");
      const total = calcAmount(panelId, row.dates||[]);
      const unpaid = calcUnpaid(panelId, row.dates||[], total);
      const remainCell = isSB ? '<td class="remain-cell">¥'+fmtJPY.format(calcRemain(row.buy, total))+'</td>' : '';
      return '<tr>\
        <td>'+(i+1)+'</td><td>'+esc(row.name)+'</td>'+buyCell+dateCells+'\
        <td class="amount-cell">¥'+fmtJPY.format(total)+'</td>'+remainCell+'\
        <td class="unpaid-cell">¥'+fmtJPY.format(unpaid)+'</td>\
        <td><button class="btn" data-action="restore" data-index="'+i+'" data-panel="'+panelId+'">戻す</button>\
            <button class="btn" data-action="cdel" data-index="'+i+'" data-panel="'+panelId+'">削除</button></td>\
      </tr>';
    }).join("");
  }

  // 初期トータル
  MAIN_TABS.forEach(updateMainUnpaid);
  updateOverallUnpaid();
})();
</script>
</body>
</html>
